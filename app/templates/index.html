<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste de Previsão</title>
</head>
<body>
    <h1>Enviar Previsão de Vendas</h1>
    <form id="forecastForm">
        <label for="store">Loja:</label>
        <input type="text" id="store" name="store" required>
        <br><br>
        
        <label for="item">Item:</label>
        <input type="text" id="item" name="item" required>
        <br><br>

        <button type="button" onclick="fetchLastDate()">Obter Última Data Disponível</button>
        <p id="lastDateInfo"></p>
        <br><br>
        
        <label for="periods">Períodos:</label>
        <input type="number" id="periods" name="periods" value="28" required>
        <br><br>

        <!-- Campo de Data Inicial opcional -->
        <label for="start_date">Data Inicial (opcional):</label>
        <input type="date" id="start_date" name="start_date">
        <br><br>
        
        <button type="button" onclick="sendData()">Enviar</button>
    </form>

    <!-- Div para exibir os resultados -->
    <div id="result"></div>

    <script>
        function fetchLastDate() {
            const store = document.getElementById("store").value;
            const item = document.getElementById("item").value;

            if (!store || !item) {
                alert("Por favor, preencha os campos Loja e Item antes de obter a última data.");
                return;
            }

            fetch(`http://127.0.0.1:8000/last_date/?store=${encodeURIComponent(store)}&item=${encodeURIComponent(item)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Modelo não encontrado para a loja e item especificados.");
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Última data disponível:", data.last_date);
                    document.getElementById("lastDateInfo").innerText = `Última data disponível: ${data.last_date}`;
                })
                .catch(error => {
                    console.error("Erro:", error);
                    document.getElementById("lastDateInfo").innerText = `Erro: ${error.message}`;
                });
        }

        function sendData() {
            const store = document.getElementById("store").value;
            const item = document.getElementById("item").value;
            const periods = parseInt(document.getElementById("periods").value);
            const startDate = document.getElementById("start_date").value;

            const dataToSend = { store, item, periods };

            if (startDate) {
                dataToSend.start_date = startDate;
            }

            console.log("Enviando dados:", dataToSend);
            document.getElementById("result").innerHTML = `<p>Processando, por favor aguarde...</p>`;

            fetch("http://127.0.0.1:8000/forecast/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.error) {
                    document.getElementById("result").innerHTML = `<p style="color: red;">Erro: ${data.error}</p>`;
                } else {
                    let forecastHtml = '<h2>Resultados da Previsão:</h2><table border="1"><tr><th>Data</th><th>Previsão de Vendas</th></tr>';
                    data.forecast.forEach(item => {
                        forecastHtml += `<tr><td>${item.date}</td><td>${item.forecast_sales.toFixed(2)}</td></tr>`;
                    });
                    forecastHtml += '</table>';
                    document.getElementById("result").innerHTML = forecastHtml;
                }
            })
            .catch(error => {
                console.error("Erro:", error);
                document.getElementById("result").innerHTML = `<p style="color: red;">Erro: ${error}</p>`;
            });
        }
    </script>
</body>
</html>
